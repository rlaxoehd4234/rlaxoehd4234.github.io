
---
layout: single
title: SqlSessionFactory, Spring-MyBatis,  Spring Bean 의 CGLIBProxy
---


### 비트 교육을 들으며 항상 JPA 만 사용하다가 MyBatis 를 쓰는 경험을 하게 되었다 .
MyBatis 를 쓰면서 궁금했던 부분들이 생겨서 한번 정리해 보려고 한다. 

우선 디비를 연결하기 위해서는 DataSource 와 Connection 을 가지고 있어야 한다. 

<img width="678" alt="스크린샷 2023-09-07 오전 9 13 49" src="https://github.com/rlaxoehd4234/rlaxoehd4234.github.io/assets/92311926/e56c2340-3520-4f13-93f1-a3a6796b416a">


내용이 조금 길어질 듯 하다

### JDBC 에 대해 먼저 알아보도록 하자. 

우선 풀 네임을 한번 보도록 하겠다. JAVA DATABASE CONNECTIVITY 이다. 
가장 원론적인 개념에 대해서 생각해보도록 하자. 자바에서 사용하는 패러다임과 데이터베이스에서 사용하는 패러다임은 무조건 다른 것을 알 수 있다. 
그래서 등장한 것이 바로 JDBC 이다. 

자바와 데이터베이스를 연결하기 위한 Java 표준 SQL 인터페이스이다. 
이 인터페이스는 MySQL 같은 다양한 DB 미들웨어 드라이버를 제공하며, java 표준이기 때문에 JVM 이 존재한다면 구애받지 않고 사용이 가능하다. 

이를 위해서 여러가지 객체가 존재하게 되는데, 
첫번째로 Connection 객체이다. 이 객체는 DB 에 연결하기 위한 객체이다. 

두번째로 PreparedStatement 객체이다.  이 객체는 쿼리 수행을 위한 객체이다. 

세번째로 resultSet 객체이다. 쿼리 실행 후에 DB 결과를 ResultSet 객체에 담아주는 것이다. 


## 그러면 이 JDBC 의 동작과정은 어떻게 될까요 ?

먼저 사용할 Database Driver 를 선택하여 Connection 을 생성합니다. -> 그 후에 쿼리 처리를 위한 preparedStatement 객체를 만들어주고, 
executeQuery() 를 사용해서, 리턴되는 결과 값을 resultSet 에 저장해서 사용합니다 .
이 모든 것을 사용하고 나서 close 를 해주어야 메모리 누수가 발생하지 않는다. 

하지만 많은 사용자가 있다고 가정했을 때, 많은 서비스에서 데이터베이스 연결이 있을 때 마다 이와 같은 연결, 해제를 반복해야 하는데 이것은 번거롭고 효율성이 떨어지는 과정이 될 것이다. 


이를 해결하기 위한 방법이 ConnectionPool 이다. 

## Connection Pool 
풀 속에 데이터베이스와 연결할 객체를 미리 여러개를 만들어 둡니다. 데이터베이스에 접근 요청이 왔을 때 그중 하나의 연결 객체를 할당하여 사용하고, 사용이 종료되면 연결 객체를 반납하는 방식입니다.

Database Connection Pool , DBCP 라고도 하며, 위에서 언급한 것 처럶 다수의 사용자가 이용하는 웹 애플리케이션의 경우 데이터베이스에 접근해야 하는 요청이 많이 발생할 것인데 그때마다 연결 객체를 만들고 
해제 하는 과정을 반복하게 되는 것은 비효율적이다. 

따라서 Connection Pool 을 미리 만들어 두고 요청시에 할당하고, 반납하는 형식을 통해 효과적으로 DB 연결 및 자원을 관리할 수 있게 됩니다. 

커넥션을 계속해서 재사용하기 때문에 생성되는 최대 커넥션 수를 제한적으로 설정하며, 커넥션 풀에 사용 가능한 커넥션이 없을 경우 사용자는 커넥션이 반환될 때까지 순서대로 대기합니다. 


ConnectionPool 의 성능적인 부분을 고려할 때는 Thread 를 함께 고려해야 합니다. 예를 들어서 Thread Pool 의 크기보다 Connection Pool 의 크기가 더 클 경우 트랜잭션을 처리하는 Thread 
가 사용하는 Connection 외에 남는 Connection 은 실질적으로 메모리 공간만 차지하게 되기 때문이다. 

DataSource 는 DB Driver 연결, Connection 객체를 관리하는 역할을 인터페이스입니다. 
DBSource 는 DB 와 관계된 Connection 정보를 담고 있으며, Bean 으로 등록하여 인자로 넘겨주는데 Spring 은 이러한 과정을 통해 DataSource로부터 DB 와의 연결을 획득합니다. 

Spring Boot 2.0 이후 버전부터는 DataSource 관리를 위한 구현체로 위에서 언급 한 것 처럼 HikariCP 를 제공됩니다. 


![스크린샷 2023-09-07 오전 9 55 43](https://github.com/rlaxoehd4234/rlaxoehd4234.github.io/assets/92311926/65825888-2e9d-4721-8c31-0442473d2198)

스프링에서는 sqlSessionFactory 에서 HikariCP 를 통해 DataSource() 를 가져온다. 이를 통해서 sqlSession 을 만들고, connection 을 얻어와서 진행한다고 볼 수 있을거 같다. 


### Spring JDBC 
Spring 에서는 기존의 JDBC 를 사용할 때 Connection, PreparedStatement, ResultSet 등의 자주 사용하는 객체와 코드들을 클래스화 하여 스프링 애플리케이션에서 보다 편리하게 
DB에 접근할 수 있는 인터페이스를 제공합니다. 

spring JDBC 는 다음과 같은 역할을 합니다. 
- Connection 을 열고 닫기
- Statement 를 준비하고 닫기
- Statement 의 실행
- ResultSet 의 반복 처리
- 예외 처리 반환
- Transaction 처리

![image](https://github.com/rlaxoehd4234/rlaxoehd4234.github.io/assets/92311926/963db014-6dbe-451c-9b19-06de7bc20042)




jdbc 에 필요한 개념들에 대해서는 다 알아본거 같다. 
이제 spring - mybatis 에서 사용하는 sqlSessionFactory 에 대해서 알아보도록 하자. 

### SqlSessionFactory
데이터베이스와의 연결과 SQL 실행에 대한 모든 것을 가진 가장 중요한 객체이다. 
이 객체가 dataSource 를 참조하여서 myBatis 와 Mysql 서버를 연동 시켜준다. 
SqlSessionFactory를 생성해주는 SqlSessionFactoryBean 객체를 먼저 설정하여야 한다. 




### Spring - MyBatis 
이 모듈은 마이바티스로 하여금 스프링 트랜잭션에 쉽게 연동되도록 처리한다. 게다가 mapper 와 sqlSession 을 다루고 다른 빈에 주입시켜준다.
마이바티스 예제를 DataAccessException 으로 변환하기도 하고 스프링 또는 마이바티스 스프링 연동 모듈에 의존성을 없애기도 한다. 

SqlSessionFactory 를 생성하기 위해 SqlSessionFactoryBean 을 사용합니다. 
SqlSessionFactory 는 dataSource 를 필요로 하는 것을 알아둘 필요가 있다. 

UserMapper 는 MapperFactoryBean 을 사용해서 스프링에 추가된다. 
매퍼는 반드시 구현체 클래스가 아닌 인터페이스로 정의되어야 한다. 예를들어, 애노테이션이 SQL을 명시하기 위해 사용되지만 마이바티스 매퍼 XML파일 또한 사용될 수 있다.

<img width="577" alt="스크린샷 2023-09-07 오전 10 33 27" src="https://github.com/rlaxoehd4234/rlaxoehd4234.github.io/assets/92311926/097a1af1-eb2c-4843-b77d-cef169597b1b">

SqlSessionFactoryBean 은 FactoryBean 을 구현하고 있다. 이 설정은 SqlSessionFactoryBean 을 생성하는 것이 아니라. factory 에서 getObject() 를 통해서 사용한다는 것을 알아야한다.


대개는 <settings>과 <typeAliases> 섹션을 변경하는 경우이다.

설정파일이 마이바티스 설정을 완전히 다룰 필요는 없다. 어떤 환경, 어떤 데이터소스 그리고 마이바티스 트랜잭션 관리자가 무시될수도 있다.
SqlSessionFactoryBean 는 필요에 따라 이 값들을 설정하여 자체적인 MyBatis Environment 를 만든다.
설정파일이 필요한 다른 이유는 마이바티스 XML파일이 매퍼 클래스와 동일한 클래스패스에 있지 않은 경우이다.
이 설정을 사용하면 두가지 옵션이 있다.  
첫번째는 마이바티스 설정파일에 <mappers> 섹션을 사용해서 XML파일의 클래스패스를 지정하는 것이다. 
두번째는 팩토리 빈의 mapperLocations 프로퍼티를 사용하는 것이다.

![스크린샷 2023-09-07 오전 10 49 46](https://github.com/rlaxoehd4234/rlaxoehd4234.github.io/assets/92311926/87d9d353-a9e2-40b0-a212-774f8c46f2cb)


또 Mybatis 연동 모듈을 사용하는 중요한 이유 증 하나는 마이바티스가 스프링 트랜잭션에 자연스럽게 연동될수 있따는 것이다. 마이바티스에 종속되는 새로운 트랜잭션을 관리를 만드는 것보다는
마이바티스 스프링 연동 모듈이 스프링의 DataSourceTransactionManager 와 융합되는 것이 좋다. 


스프링의 표준 설정은 이러하다.
<bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
  <constructor-arg ref="dataSource" />
</bean>


마이바티스에서는 SqlSession를 생성하기 위해 SqlSessionFactory를 사용한다.
세션을 한번 생성하면 매핑구문을 실행하거나 커밋 또는 롤백을 하기 위해 세션을 사용할수 있다. 
마지막으로 더 이상 필요하지 않은 상태가 되면 세션을 닫는다. 
마이바티스 스프링 연동모듈을 사용하면 SqlSessionFactory를 직접 사용할 필요가 없다. 
왜냐하면, 스프링 트랜잭션 설정에 따라 자동으로 커밋 혹은 롤백을 수행하고 닫혀지는, 쓰레드에 안전한 SqlSession 개체가 스프링 빈에 주입될 수 있기 때문이다.



